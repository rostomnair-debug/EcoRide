{% extends 'layout/legacy.html.twig' %}
{% block legacy_title %}EcoRide - Profil {{ profileUser.pseudo ?? profileUser.prenom }}{% endblock %}

{% block legacy_body %}
<section class="container my-5">
    <div class="page-hero mb-4">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
            <div>
                <h1 class="h4 fw-bold mb-1">{{ profileUser.pseudo ?? profileUser.prenom }}</h1>
                <p class="mb-0 text-muted">
                    <span class="text-success">Membre EcoRide</span>
                    {% if profileUser.createdAt %} · <span class="text-secondary">Inscription le {{ profileUser.createdAt|date('d/m/Y') }}</span>{% endif %}
                </p>
            </div>
            <div class="d-flex gap-2 flex-wrap">
                <span class="badge-soft">
                {% if profileUser.voitures|length > 0 %}
                    <span>Passager / Chauffeur</span>
                {% else %}
                    <span>Passager</span>
                {% endif %}
                </span>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-4">
            <div class="surface-card p-3 h-100 text-center">
                <div class="mb-3">
                    {% set avatar = profileUser.photo ? asset(profileUser.photo) : (profileUser.verifie ? asset('assets/profile-verified.svg') : asset('assets/profile-default.svg')) %}
                    <img src="{{ avatar }}" alt="Profil" class="rounded-circle shadow-soft" style="width:96px;height:96px;object-fit:cover;">
                </div>
                <h5 class="fw-bold mb-3">Informations</h5>
                <ul class="list-unstyled text-muted small mb-0">
                    <li class="mb-2"><strong>Pseudo :</strong> {{ profileUser.pseudo ?? '-' }}</li>
                    <li class="mb-2"><strong>Nom :</strong> {{ profileUser.prenom }} {{ profileUser.nom }}</li>
                </ul>
                    {% if profileUser.verifie %}
                        · <span class="badge bg-success"><i class="bi bi-patch-check-fill me-1"></i>Vérifié</span>
                    {% else %}
                        · <span class="badge bg-light text-secondary border">Non vérifié</span>
                    {% endif %}
                    {% set hasAvg = profileAvg is defined and profileAvg > 0 %}
                    {% set hasAvis = avisList is defined and avisList is not empty %}
                    {% if hasAvg %}
                        · <span class="text-warning fw-semibold">⭐ {{ profileAvg|number_format(1, ',', ' ') }}/5</span>
                    {% elseif hasAvis %}
                        · <span class="text-muted">Note en attente de validation</span>
                    {% else %}
                        · <span class="text-muted">Aucune note pour l'instant</span>
                    {% endif %}
                {% if profileUser.voitures|length > 0 %}
                    <div class="mt-3">
                        <h6 class="fw-bold">Véhicules</h6>
                        <ul class="list-unstyled mb-0">
                            {% for v in profileUser.voitures %}
                                <li class="mb-2">
                                    <div class="fw-semibold">{{ v.marque.libelle }} {{ v.modele }}</div>
                                    <div class="text-muted small">{{ v.energie|capitalize }} · {{ v.couleur }} · {{ v.immatriculation }}</div>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="col-md-8">
            <div class="surface-card p-3 h-100">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Avis</h5>
                    <span class="badge-soft">{{ avisList|length }} avis</span>
                </div>
                {% if avisList is empty %}
                    <div class="card-quiet">Aucun avis pour le moment.</div>
                {% else %}
                    <div class="list-group list-group-flush">
                        {% for avis in avisList %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-semibold">Note : ⭐ {{ avis.note }}</span>
                                    <span class="badge bg-light text-success">{{ avis.statut|capitalize }}</span>
                                </div>
                                <p class="mb-1 text-muted small">{{ avis.commentaire }}</p>
                                {% if avis.covoiturage %}
                                    <p class="mb-0 text-muted small">Trajet : {{ avis.covoiturage.lieuDepart }} → {{ avis.covoiturage.lieuArrivee }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="row g-4 mt-3">
        <div class="col-12">
            <div class="surface-card p-3">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Derniers trajets</h5>
                    <span class="badge-soft">{{ lastTrips|length }}</span>
                </div>
                {% if lastTrips is empty %}
                    <div class="card-quiet">Aucun trajet récent.</div>
                {% else %}
                    <div class="table-responsive">
                        <table class="table align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>Rôle</th>
                                    <th>Trajet</th>
                                    <th>Date</th>
                                    <th>Places</th>
                                    <th>Statut</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for trip in lastTrips %}
                                    {% set isDriver = trip.voiture.proprietaire.id == profileUser.id %}
                                    <tr>
                                        <td><span class="badge {{ isDriver ? 'bg-success' : 'bg-light text-success' }}">{{ isDriver ? 'Chauffeur' : 'Passager' }}</span></td>
                                        <td>{{ trip.lieuDepart }} → {{ trip.lieuArrivee }}</td>
                                        <td>{{ trip.dateDepart|date('d/m/Y') }} · {{ trip.heureDepart|date('H\\hi') }}</td>
                                        <td>{{ trip.nbPlace }}</td>
                                        <td><span class="badge bg-light text-success">{{ trip.statut|capitalize }}</span></td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}
